# Роли и доступ (RBAC)

Единое описание ролей и разграничения доступа в системе недвижимости: кто что может делать и над какими данными.

---

## 1. Два контура системы

| Контур | Кто входит | Где хранится | Где работает |
|--------|------------|--------------|--------------|
| **Приложение (MiniApp / веб)** | Конечный пользователь — ищет объявления, пишет партнёрам | `miniapp_users` | Публичное приложение, Telegram MiniApp |
| **Админ-панель** | Администраторы с разными правами | `admin_users` (поле `role`) | Закрытая админка |

Роли из этого документа в основном про **админ-панель**. Пользователь приложения — отдельный тип учётки, без роли в `admin_role`.

---

## 2. Пользователь приложения (MiniApp)

Не админ, не входит в админку.

**Может:**
- Искать объявления по параметрам, просматривать карточки и туры.
- Сохранять объявления (избранное), пересылать ссылку в Telegram.
- Подписываться на рассылку по параметрам и на show room партнёров.
- Писать по кнопке на контакты из объявления и звонить из Telegram по кнопке.
- Создать аккаунт через привязку Telegram.

**Ограничение:** без привязки аккаунта доступен только просмотр объявлений; писать нельзя.

**Хранение:** таблица `miniapp_users` (идентификация по хешу Telegram и т.п.).

---

## 3. Роли в админ-панели: что может каждая роль

Кратко — какой функционал доступен каждой роли.

| Роль | Функционал |
|------|------------|
| **Partner** (Партнер) | Только **свои** объекты, метрики и ссылки (`partner_id = свой`). Создание/редактирование/удаление своих объявлений и ссылок, аналитика по своим данным. Не видит других партнёров. Лимиты объявлений зависят от уровня (Free / Business / VIP) — см. раздел 4. |
| **Developer** (Застройщик) | Только **свои** объекты (`developer_id = свой`, тип developer_tour). Создание/редактирование/удаление своих объектов. |
| **Support** (Техподдержка) | Просмотр всего контента. Модерация объявлений (очередь, статусы, проверка Matterport). Редактирование и удаление объявлений. Доступ к чатам, куда приглашён; бан/восстановление аккаунтов пользователей; выдача прав. **Не может:** менять цены и привязку к партнёру, заходить в системные настройки. |
| **Viewer** (Пользователь) | Только **чтение** всего контента. Без изменений и модерации. |
| **Admin** (Админ) | Всё, кроме системных настроек: объекты, партнёры, застройщики, пользователи — создание/редактирование/удаление; публикация и архивирование объявлений; полная аналитика; импорт/экспорт; управление пользователями и правами. |
| **SuperAdmin** (Суперадмин) | **Полный доступ:** всё, что у Admin, плюс системные настройки, интеграции, управление 2FA других админов, полный доступ к audit_log, бэкапы. |

---

## 4. Уровни партнёра (Partner)

Одна роль **Partner**, но у партнёра есть уровень — от него зависят лимиты и доп. возможности. В БД уровень пока не заведён (запланировано).

| Уровень | Лимит объявлений | Дополнительно |
|---------|------------------|---------------|
| **Free** | 5 | Свои объявления (создание/редактирование/удаление). Доступ к чату с пользователем, если чат начал пользователь. |
| **Business** | 20 | Всё то же + страница компании «show room» (создание и редактирование), привязка нескольких аккаунтов для постинга объявлений. |
| **VIP** | 50 | Всё как в Business + личный менеджер и дополнительные услуги (не влияют на функционал приложения). |

---

## 5. Матрица: роль × операция (для реализации)

Какие операции разрешены какой роли. Scope: **own** — только свои данные (фильтр по `partner_id` / `developer_id`), **full** — все данные.

| Операция | Partner | Developer | Support | Viewer | Admin | SuperAdmin |
|----------|---------|-----------|---------|--------|-------|------------|
| READ (own) | ✓ | ✓ | — | — | — | — |
| READ (full) | — | — | ✓ | ✓ | ✓ | ✓ |
| CREATE / UPDATE / DELETE (own) | ✓ | ✓ | — | — | — | — |
| CREATE / UPDATE / DELETE (full) | — | — | — | — | ✓ | ✓ |
| PUBLISH / ARCHIVE | — | — | ✓* | — | ✓ | ✓ |
| ANALYTICS (own) | ✓ | — | — | — | — | — |
| ANALYTICS (full) | — | — | — | — | ✓ | ✓ |
| MODERATE (очередь, статусы) | — | — | ✓ | — | ✓ | ✓ |
| MANAGE USERS | — | — | ✓ | — | ✓ | ✓ |
| IMPORT / EXPORT | — | — | — | — | ✓ | ✓ |
| SYSTEM SETTINGS | — | — | — | — | — | ✓ |

\* Support: изменение статусов/модерация объявлений, но не смена цен и партнёра.

---

## 6. Операции и ресурсы БД

К каким таблицам относятся операции (для реализации проверок и фильтров).

| Ресурс (таблица) | Описание |
|------------------|----------|
| `objects` | Объявления (объекты недвижимости) |
| `partners` | Партнёры |
| `developers` | Застройщики |
| `admin_users` | Администраторы |
| `miniapp_users` | Пользователи приложения |
| `events` | События аналитики |
| `links` | Deeplinks и кампании |
| `audit_log` | Журнал изменений |

| Операция | Ресурсы |
|----------|---------|
| READ (own) | objects, events, links (фильтр по partner_id / developer_id) |
| READ (full) | Все перечисленные выше |
| CREATE/UPDATE/DELETE | objects, partners, developers, admin_users, miniapp_users, events, links — с ограничением по роли (own/full) |
| PUBLISH/ARCHIVE | objects (`published_status`) |
| ANALYTICS (own) | events (`source = partner_{id}`) |
| ANALYTICS (full) | events |
| MANAGE USERS | admin_users, miniapp_users |
| SYSTEM SETTINGS | admin_users, конфигурация системы |
| IMPORT/EXPORT | objects |
| MODERATE | objects (очередь модерации, статусы) |

---

## 7. Аудит (audit_log)

В `audit_log` пишется:
- все мутации (CREATE/UPDATE/DELETE) по сущностям системы;
- смена статусов публикации (publish/archive);
- изменение прав доступа;
- входы в систему и операции 2FA.

Поля: `admin_user_id`, `action`, `entity`, `entity_id`, `before` / `after` (jsonb), `ip`, `ua`, `ts`.

---

## Приложение A. Соответствие источников

| Роль в документе | Диаграмма RBAC | Текстовое описание | В БД (admin_role) |
|------------------|----------------|-------------------|-------------------|
| Пользователь приложения | — | Пользователь | не роль; сущность miniapp_users |
| Partner (Free/Business/VIP) | Partner | Партнер 1–3 | Partner |
| Developer | Developer | — | Developer |
| Support | Support | Админ (Тех поддержка) | Support |
| Viewer (Пользователь) | Viewer | Пользователь | Viewer |
| Admin | Admin | CEO, ЛПР (частично) | Admin |
| SuperAdmin | SuperAdmin | CEO, ЛПР, разработчик (все доступы) | SuperAdmin |

«Админ (Тех поддержка)» из текста = роль **Support** на диаграмме. «CEO, ЛПР, разработчик — все доступы» отображаются как **SuperAdmin** (или **Admin**). Роль **Developer** в БД — это застройщик (доступ только к своим объектам), а не «разработчик с полным доступом».

---

## Приложение B. Текущее состояние (мок)

- Схема и enum ролей: [infrastructure/postgres/init.sql](../infrastructure/postgres/init.sql).
- Enum **admin_role**: `SuperAdmin`, `Admin`, `Partner`, `Developer`, `Support`, `Viewer`.
- Таблицы: `partners`, `developers`, `objects`, `admin_users`, `miniapp_users`, `links`, `events`, `audit_log`.

Пока не реализовано в БД:
- уровень партнёра (Free/Business/VIP) и лимиты объявлений;
- проверки прав в API по роли и scope (own/full).

Диаграммы: [roles.puml](roles.puml).
